<div class="admin-peliculas">
  <div class="admin-section-header">
    <div>
      <h2><i class="fas fa-film"></i> Gesti√≥n de Pel√≠culas</h2>
      <p class="subtitle">Administra el cat√°logo de pel√≠culas del cine</p>
    </div>
    <button class="btn btn-primary" (click)="nuevaPelicula()">
      <i class="fas fa-plus"></i> Agregar Pel√≠cula
    </button>
  </div>

  <!-- Filtros -->
  <div class="filtros-card">
    <div class="card-body">
        <div class="filtros-row">
          <div class="filtro-pelicula position-relative">
          <label for="buscarPelicula" class="form-label">Filtrar por pel√≠cula:</label>
          <input 
            type="text" 
            id="buscarPelicula" 
            class="form-control" 
            [(ngModel)]="filtroBusqueda" 
            (input)="onBusquedaInput($event)"
            (focus)="mostrarSugerencias = true"
            (blur)="ocultarSugerencias()"
            placeholder="Buscar por t√≠tulo..."
            autocomplete="off">
          
          <!-- Dropdown de sugerencias -->
          <div class="sugerencias-dropdown" *ngIf="mostrarSugerencias && sugerenciasPeliculas.length > 0">
            <div class="sugerencia-item" 
                 *ngFor="let pelicula of sugerenciasPeliculas; let i = index"
                 (mousedown)="seleccionarSugerencia(pelicula)"
                 [class.active]="i === sugerenciaSeleccionada">
              <img [src]="pelicula.posterUrl || 'assets/images/default-poster.svg'" 
                   [alt]="pelicula.titulo"
                   class="sugerencia-poster"
                   onerror="this.src='assets/images/default-poster.svg'">
              <div class="sugerencia-info">
                <div class="sugerencia-titulo">{{ pelicula.titulo }}</div>
                <div class="sugerencia-detalles">
                  <span class="badge bg-secondary me-1">{{ pelicula.clasificacion }}</span>
                  <span class="text-muted">{{ pelicula.duracionMin }} min</span>
                  <span class="badge ms-1" [ngClass]="{
                    'bg-success': pelicula.estado === 'ACTIVA',
                    'bg-danger': pelicula.estado === 'INACTIVA'
                  }">{{ pelicula.estado }}</span>
                </div>
                <div class="sugerencia-generos" *ngIf="pelicula.generos && pelicula.generos.length > 0">
                  <small class="text-muted">{{ pelicula.generos.slice(0, 3).join(', ') }}</small>
                </div>
              </div>
            </div>
            
            <!-- Mensaje cuando no hay sugerencias -->
            <div class="no-sugerencias" *ngIf="filtroBusqueda && sugerenciasPeliculas.length === 0">
              <i class="fas fa-search text-muted"></i>
              <small class="text-muted">No se encontraron pel√≠culas con "{{ filtroBusqueda }}"</small>
            </div>
          </div>
        </div>
        <div class="filtro-estado">
          <label for="filtroEstado" class="form-label">Filtrar por estado:</label>
          <select id="filtroEstado" class="form-control" [(ngModel)]="filtroEstado" (change)="aplicarFiltroBusqueda()">
            <option value="">Todos los estados</option>
            <option value="ACTIVA">Activas</option>
            <option value="INACTIVA">Inactivas</option>
          </select>
        </div>
        <div class="filtro-genero">
          <label for="filtroGenero" class="form-label">Filtrar por g√©nero:</label>
          <select id="filtroGenero" class="form-control" [(ngModel)]="filtroGenero" (change)="aplicarFiltroBusqueda()">
            <option value="">Todos los g√©neros</option>
            <option *ngFor="let genero of generosDisponibles" [value]="genero">{{genero}}</option>
          </select>
        </div>
        <div class="col-md-1">
          <label class="form-label">&nbsp;</label>
          <button class="btn btn-outline-secondary form-control" 
                  (click)="limpiarFiltros()"
                  [disabled]="!hayFiltrosActivos()"
                  title="Limpiar filtros">
            <i class="fas fa-times"></i>
            <span *ngIf="hayFiltrosActivos()" class="badge bg-danger position-absolute top-0 start-100 translate-middle">{{contarFiltrosActivos()}}</span>
          </button>
        </div>
        </div>
      </div>
  </div>

  <!-- Modal/Form para pel√≠cula -->
  <div class="modal" *ngIf="mostrarFormulario">
    <div class="modal-content">
      <h3>{{ peliculaSeleccionada ? 'Editar' : 'Nueva' }} Pel√≠cula</h3>
      <form [formGroup]="peliculaForm" (ngSubmit)="guardarPelicula()">
        <div class="form-group">
          <label for="titulo">T√≠tulo</label>
          <div class="input-with-button">
            <input type="text" id="titulo" formControlName="titulo" class="form-control">
            <button 
              type="button" 
              class="btn btn-primary btn-autocompletar" 
              (click)="autocompletarConIA()"
              [disabled]="!peliculaForm.get('titulo')?.value || cargandoIA"
              title="Autocompletar con Gemini AI">
              <i class="fas" [ngClass]="cargandoIA ? 'fa-spinner fa-spin' : 'fa-magic'"></i>
              {{ cargandoIA ? 'Consultando...' : 'IA' }}
            </button>
          </div>
          <small class="form-text text-muted" *ngIf="peliculaForm.get('titulo')?.value">
            Ingresa el t√≠tulo y haz clic en "IA" para rellenar autom√°ticamente los dem√°s campos
          </small>
        </div>

        <div class="form-group">
          <label for="sinopsis">Sinopsis</label>
          <textarea 
            id="sinopsis" 
            formControlName="sinopsis" 
            class="form-control" 
            rows="4"
            placeholder="Describe la trama de la pel√≠cula..."
          ></textarea>
        </div>

        <div class="form-group">
          <label for="duracionMin">Duraci√≥n (minutos)</label>
          <input 
            type="number" 
            id="duracionMin" 
            formControlName="duracionMin" 
            class="form-control"
            min="1"
            step="1"
            placeholder="Ej: 120">
        </div>

        <div class="form-group">
          <label for="clasificacion">Clasificaci√≥n</label>
          <select id="clasificacion" formControlName="clasificacion" class="form-control">
            <option value="">Selecciona una clasificaci√≥n</option>
            <option value="G">G - P√∫blico General</option>
            <option value="PG">PG - Se sugiere orientaci√≥n de los padres</option>
            <option value="PG-13">PG-13 - Mayores de 13 a√±os</option>
            <option value="R">R - Restringida (Mayores de 17 a√±os)</option>
            <option value="NC-17">NC-17 - Solo adultos (Mayores de 18 a√±os)</option>
          </select>
        </div>

        <div class="form-group">
          <label for="generos">G√©neros</label>
          <select 
            id="generos" 
            formControlName="generos" 
            class="form-control" 
            multiple
            size="8">
            <option value="Acci√≥n">Acci√≥n</option>
            <option value="Aventura">Aventura</option>
            <option value="Animaci√≥n">Animaci√≥n</option>
            <option value="Ciencia Ficci√≥n">Ciencia Ficci√≥n</option>
            <option value="Comedia">Comedia</option>
            <option value="Crimen">Crimen</option>
            <option value="Documental">Documental</option>
            <option value="Drama">Drama</option>
            <option value="Familiar">Familiar</option>
            <option value="Fantas√≠a">Fantas√≠a</option>
            <option value="Historia">Historia</option>
            <option value="Horror">Horror</option>
            <option value="M√∫sica">M√∫sica</option>
            <option value="Misterio">Misterio</option>
            <option value="Romance">Romance</option>
            <option value="Suspenso">Suspenso</option>
            <option value="Terror">Terror</option>
            <option value="Western">Western</option>
          </select>
          <small class="form-text text-muted">
            Mant√©n presionada la tecla Ctrl para seleccionar m√∫ltiples g√©neros
          </small>
        </div>

        <div class="form-group">
          <label for="posterUrl">URL del P√≥ster</label>
          <input type="text" id="posterUrl" formControlName="posterUrl" class="form-control">
        </div>

        <div class="form-group">
          <label for="trailerUrl">URL del Trailer</label>
          <input type="text" id="trailerUrl" formControlName="trailerUrl" class="form-control">
        </div>

        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input 
              type="checkbox" 
              formControlName="esProximoEstreno"
              (change)="onProximoEstrenoChange()">
            <span>üé¨ Marcar como Pr√≥ximo Estreno</span>
          </label>
          <small class="form-text text-muted">
            Las pel√≠culas marcadas aparecer√°n en la secci√≥n "PR√ìXIMOS ESTRENOS"
          </small>
        </div>

        <div class="form-group" *ngIf="peliculaForm.get('esProximoEstreno')?.value">
          <label for="fechaEstreno">Fecha de Estreno</label>
          <input 
            type="date" 
            id="fechaEstreno" 
            formControlName="fechaEstreno" 
            [min]="fechaMinima"
            class="form-control"
            placeholder="Fecha de estreno en cines">
          <small class="form-text text-muted">
            Selecciona la fecha en que la pel√≠cula se estrenar√° en cines (no puede ser anterior a hoy)
          </small>
        </div>

        <div class="form-group">
          <label for="estado">Estado</label>
          <select id="estado" formControlName="estado" class="form-control">
            <option value="ACTIVA">Activa</option>
            <option value="INACTIVA">Inactiva</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="mostrarFormulario = false">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="peliculaForm.invalid">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Grid de pel√≠culas -->
  <div class="peliculas-grid" *ngIf="peliculasFiltradas.length > 0">
    <div class="pelicula-card" *ngFor="let pelicula of peliculasFiltradas">
      <img [src]="pelicula.posterUrl || 'assets/images/default-poster.svg'" 
           [alt]="pelicula.titulo"
           [title]="pelicula.titulo">
      <div class="pelicula-info">
        <h3>{{ pelicula.titulo }}</h3>
        <p class="duracion">{{ pelicula.duracionMin }} minutos</p>
        <p class="clasificacion">{{ pelicula.clasificacion }}</p>
        <p class="estado">Estado: {{ pelicula.estado }}</p>
        <div class="acciones">
          <button class="btn btn-sm btn-primary" (click)="editarPelicula(pelicula)">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="btn btn-sm btn-danger" (click)="eliminarPelicula(pelicula.id)">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controles de paginaci√≥n -->
  <div class="pagination-section" *ngIf="totalPaginas > 1">
    <div class="pagination-controls">
      <button class="btn-pagination btn-anterior" 
              (click)="irAPaginaAnterior()" 
              [disabled]="paginaActual === 1">
        <i class="fas fa-chevron-left"></i> Anterior
      </button>
      
      <div class="page-numbers">
        <button *ngFor="let pagina of paginasArray" 
                class="btn-page"
                [class.active]="pagina === paginaActual"
                (click)="irAPagina(pagina)">
          {{ pagina }}
        </button>
      </div>
      
      <button class="btn-pagination btn-siguiente" 
              (click)="irAPaginaSiguiente()" 
              [disabled]="paginaActual === totalPaginas">
        Siguiente <i class="fas fa-chevron-right"></i>
      </button>
    </div>
    
    <div class="pagination-info">
      Mostrando {{ (paginaActual - 1) * peliculasPorPagina + 1 }} - 
      {{ paginaActual * peliculasPorPagina > totalPeliculas ? totalPeliculas : paginaActual * peliculasPorPagina }} 
      de {{ totalPeliculas }} pel√≠culas
    </div>
  </div>

  <!-- Mensaje cuando no hay resultados -->
  <div class="no-results" *ngIf="peliculasFiltradas.length === 0 && todasLasPeliculas.length > 0">
    <div class="text-center py-5">
      <i class="fas fa-search fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">No se encontraron pel√≠culas</h4>
      <p class="text-muted">No hay pel√≠culas que coincidan con los filtros aplicados</p>
      <button class="btn btn-outline-primary" (click)="limpiarFiltros()">
        <i class="fas fa-times"></i> Limpiar filtros
      </button>
    </div>
  </div>

  <!-- Mensaje cuando no hay pel√≠culas -->
  <div class="no-movies" *ngIf="todasLasPeliculas.length === 0">
    <div class="text-center py-5">
      <i class="fas fa-film fa-3x text-muted mb-3"></i>
      <h4 class="text-muted">No hay pel√≠culas registradas</h4>
      <p class="text-muted">Comienza agregando tu primera pel√≠cula</p>
      <button class="btn btn-primary" (click)="nuevaPelicula()">
        <i class="fas fa-plus"></i> Agregar primera pel√≠cula
      </button>
    </div>
  </div>

  <!-- Modal para crear funci√≥n -->
  <div class="modal" *ngIf="funcionForm.get('peliculaId')?.value">
    <div class="modal-content">
      <h3>Nueva Funci√≥n</h3>
      
      <!-- Info de debug -->
      <div class="debug-info">
        <strong>Debug Info:</strong><br>
        Pel√≠cula ID: {{ funcionForm.get('peliculaId')?.value }}<br>
        Salas disponibles: {{ salas.length }}<br>
        Formulario v√°lido: {{ funcionForm.valid ? '‚úÖ' : '‚ùå' }}<br><br>
        
        <strong>Estado de campos:</strong><br>
        ‚Ä¢ Sala: {{ funcionForm.get('salaId')?.value || 'Sin seleccionar' }} 
        {{ funcionForm.get('salaId')?.valid ? '‚úÖ' : '‚ùå' }}<br>
        ‚Ä¢ Fecha/Hora: {{ funcionForm.get('inicio')?.value || 'Sin seleccionar' }} 
        {{ funcionForm.get('inicio')?.valid ? '‚úÖ' : '‚ùå' }}<br>
        ‚Ä¢ Precio: {{ funcionForm.get('precio')?.value || 'Sin ingresar' }} 
        {{ funcionForm.get('precio')?.valid ? '‚úÖ' : '‚ùå' }}<br>
        
        <div *ngIf="!funcionForm.valid" class="debug-errors">
          <strong>Errores:</strong><br>
          <div *ngIf="funcionForm.get('salaId')?.errors">
            ‚Ä¢ Sala: {{ funcionForm.get('salaId')?.errors | json }}
          </div>
          <div *ngIf="funcionForm.get('inicio')?.errors">
            ‚Ä¢ Fecha: {{ funcionForm.get('inicio')?.errors | json }}
          </div>
          <div *ngIf="funcionForm.get('precio')?.errors">
            ‚Ä¢ Precio: {{ funcionForm.get('precio')?.errors | json }}
          </div>
        </div>
      </div>
      
      <form [formGroup]="funcionForm" (ngSubmit)="guardarFuncion()">
        <div class="form-group">
          <label for="salaId">Sala</label>
          <select id="salaId" formControlName="salaId" class="form-control">
            <option value="">Selecciona una sala</option>
            <option *ngFor="let sala of salas" [value]="sala.id">
              {{ sala.nombre }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label for="inicio">Fecha y Hora</label>
          <input type="datetime-local" id="inicio" formControlName="inicio" class="form-control" 
                 (change)="verificarDisponibilidadSala()">
          <small class="form-text text-muted">
            Se verificar√° autom√°ticamente la disponibilidad al cambiar la fecha/hora
          </small>
        </div>

        <div class="form-group">
          <label for="precio">Precio</label>
          <input type="number" id="precio" formControlName="precio" class="form-control" 
                 min="0" step="0.01" placeholder="Ej: 150.00">
        </div>

        <!-- Informaci√≥n de disponibilidad -->
        <div class="alert" *ngIf="disponibilidadInfo" 
             [ngClass]="{
               'alert-success': disponibilidadInfo.includes('‚úÖ'),
               'alert-warning': disponibilidadInfo.includes('‚ö†Ô∏è'),
               'alert-danger': disponibilidadInfo.includes('‚ùå')
             }">
          <pre>{{ disponibilidadInfo }}</pre>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-info" 
                  (click)="verificarDisponibilidadSala()"
                  [disabled]="!funcionForm.get('salaId')?.value || !funcionForm.get('inicio')?.value">
            üîç Verificar Disponibilidad
          </button>
          <button type="button" class="btn btn-info" 
                  (click)="analizarConflicto()"
                  [disabled]="!funcionForm.get('salaId')?.value || !funcionForm.get('inicio')?.value">
            üîç Analizar Conflictos
          </button>
          <button type="button" class="btn btn-info" (click)="mostrarTodasLasFunciones()">
            üìã Ver Todas las Funciones
          </button>
          <button type="button" class="btn btn-info" (click)="limpiarBaseDatos()">
            üìÖ Buscar por Fecha
          </button>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-warning" (click)="debugFormulario()">
            üêõ Debug Formulario
          </button>
          <button type="button" class="btn btn-warning" (click)="simularCreacion()">
            üß™ Simular Creaci√≥n
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelarFuncion()">Cancelar</button>
          <button type="submit" class="btn btn-primary" [disabled]="funcionForm.invalid">Crear Funci√≥n</button>
        </div>
      </form>
    </div>
  </div>
</div>